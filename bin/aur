#!/usr/bin/env ruby
# frozen_string_literal: true

require 'docopt'
require 'pathname'
require_relative '../lib/aur/action'

CMDS = %i[info verify split tag2name name2tag numname sort inumber
          number].freeze

docopt = <<~EOCMDS
  Usage:
    aur info <file>...
    aur verify <file>...
    aur split <file>...
    aur tag2name <file>...
    aur name2tag <file>...
    aur numname <file>...
    aur sort <file>...
    aur inumber <file>...
    aur number <file>...
EOCMDS

def sanitize_keys(options)
  options.transform_keys do |k|
    k.to_s.delete('-').to_sym
  end
end

def errors(errs)
  return if errs.empty?

  warn "Completed with #{errs.size} errors."
  errs.each { |err| warn "  #{err}" }
  exit 1
end

begin
  opts = sanitize_keys(Docopt.docopt(docopt))
rescue Docopt::Exit => e
  abort e.message
end

CMDS.each do |cmd|
  next unless opts[cmd]

  cmd = Aur::Action.new(cmd, opts)
  cmd.run!
  errors(cmd.errs)
  exit
end

abort 'Unhandled command.'
